<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>我的信息 - 螺旋论坛</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">论坛</div>
            <div>
                <a href="index.html" class="back-button" style="margin-left: 0;">返回首页</a>
            </div>
        </header>
        <main>
            <div class="chat-layout">
                <!-- 左侧联系人列表 -->
                <div class="contact-list" id="contact-list-container">
                    <h2>私信列表 <button onclick="alert('已全部设为已读！')">一键已读</button></h2>
                    
                    <!-- 联系人1: 喷子 -->
                    <div class="contact-item" data-contact-id="troll">
                        <img src="https://via.placeholder.com/48/000/FFF?text=剑" alt="avatar" class="contact-avatar">
                        <div class="contact-info">
                            <div class="name">sohnwhnalqq9912_xlk</div>
                            <div class="preview">像你这种阴暗老鼠就只敢躲在...</div>
                        </div>
                    </div>
                    
                    <!-- 联系人2: 用户21 -->
                    <div class="contact-item" data-contact-id="user21">
                        <img src="https://via.placeholder.com/48/ccc/000?text=?" alt="avatar" class="contact-avatar">
                        <div class="contact-info">
                            <div class="name">用户21</div>
                            <div class="preview">很抱歉，冒昧打扰……我失忆了...</div>
                        </div>
                    </div>

                    <!-- 其他陌生人 -->
                    <div class="contact-item"><img src="https://via.placeholder.com/48" class="contact-avatar"><div class="contact-info"><div class="name">陌生人1</div><div class="preview">求求你放过我吧大哥！</div></div></div>
                    <div class="contact-item"><img src="https://via.placeholder.com/48" class="contact-avatar"><div class="contact-info"><div class="name">陌生人2</div><div class="preview">有种别删，我一定找到你！</div></div></div>

                </div>
                
                <!-- 右侧内容容器 -->
                <div id="chat-content-area" class="chat-window" style="align-items: center; justify-content: center;">
                    <h2 style="color: #999;">点击左侧联系人开始对话</h2>
                </div>
            </div>
        </main>
    </div>

    <!-- 引入TypeIt库 -->
    <script src="typeit.min.js"></script>

    <!-- 最终版的JS控制脚本 -->
    <script>
        // --- 数据中心 ---
        const chatData = {
            troll: {
                name: 'sohnwhnalqq9912_xlk',
                profileLink: '#', // 喷子没有主页
                script: [
                    { type: 'received', text: '像你这种阴暗老鼠就只敢躲在电脑后面，一定丑得惊人，在现实里活得很可怜吧。' },
                    { type: 'sent-ime', pinyin: 'xìn bu xìn wǒ bǎ nǐ kāi le', text: '信不信我把你开了。' },
                    { type: 'received', text: '刚注册的新号，你开。' },
                    { type: 'pause' },
                    { type: 'sent', text: '张伟' },
                    { type: 'sent', text: '23岁，家住幸福小区3栋401' },
                    { type: 'sent', text: '你昨天刚买的螺蛳粉，今天应该到了吧？' },
                    { type: 'sent', text: '你最近总是在看二手车网站，想买高尔夫？' },
                    { type: 'received', text: '大哥我错了！！！' },
                    { type: 'received', text: '求求你别发了，我给你磕头了！' }
                ]
            },
            user21: {
                name: '用户21',
                profileLink: 'user21_profile.html', // 指向用户21的主页
                script: [
                    { type: 'received', text: '很抱歉，冒昧打扰……我失忆了，目前只有一台电脑，我想从电脑里找到一些线索。' },
                    { type: 'sent-ime', pinyin: 'yǒu bìng qù yī yuàn', text: '有病去医院。' },
                    { type: 'received', text: '我无法去医院。' },
                    { type: 'received', text: '抱歉，毕竟这是一台被格式化的电脑，我想这个请求确实太强人所难了。' },
                    { type: 'sent-ime', pinyin: 'hā?', text: '哈？' },
                    { type: 'sent-ime', pinyin: 'nǐ jué de qū qū gé shì huà néng lán zhù wǒ ma', text: '你觉得区区格式化能拦住我吗？' },
                    { type: 'sent-ime', pinyin: 'xìn xī zhǐ yào cóng yìng pán shàng liú guò, jiù huì liú xià hén jì', text: '信息只要从硬盘上流过，就会留下痕迹。' },
                    { type: 'received', text: '谢谢……那就拜托您了！' },
                    { type: 'sent', text: '………………………………' },
                    { type: 'received', text: '我可以把我的电脑权限完全对您敞开。' },
                    { type: 'sent-ime', pinyin: 'yòng bu zháo!!!', text: '用不着！！！' }
                ]
            }
        };

        const contentArea = document.getElementById('chat-content-area');
        const contactItems = document.querySelectorAll('.contact-item');
        let activeChatScript = null;
        let currentStep = 0;
        let isTyping = false;
        
        // --- 核心功能：加载聊天界面 ---
        function loadChat(contactId) {
            // 重置状态
            isTyping = false;
            currentStep = 0;
            const data = chatData[contactId];
            if (!data) return;
            
            activeChatScript = data.script;
            
            // 动态生成右侧聊天窗口HTML
            contentArea.style = ''; // 清除初始样式
            contentArea.innerHTML = `
                <div class="chat-header"><a href="${data.profileLink}">${data.name}</a></div>
                <div class="chat-messages" id="message-container"></div>
                <div class="chat-input-area">
                    <input type="text" id="fake-input" class="chat-input" placeholder="输入消息..." readonly>
                    <button id="send-btn" class="send-button disabled" disabled>↑</button>
                </div>
            `;
            
            // 更新左侧列表的选中状态
            contactItems.forEach(item => item.classList.remove('active'));
            document.querySelector(`[data-contact-id="${contactId}"]`).classList.add('active');
            
            console.log(`已加载 ${data.name} 的对话。按空格键开始。`);
        }

        // --- 事件绑定 ---
        contactItems.forEach(item => {
            const contactId = item.dataset.contactId;
            if (contactId) {
                item.addEventListener('click', () => loadChat(contactId));
            }
        });

        document.body.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && activeChatScript) {
                e.preventDefault();
                nextStep();
            }
        });

        // --- 对话推进逻辑 (和之前版本类似，但更健壮) ---
        function nextStep() {
            if (currentStep >= activeChatScript.length || isTyping) return;
            isTyping = true;
            const step = activeChatScript[currentStep];

            if (step.type === 'pause') {
                console.log("--- 剧情暂停点 ---");
                isTyping = false;
                currentStep++;
                return;
            }

            if (step.type === 'received') {
                showInChat(step.text, 'received', () => { isTyping = false; });
                currentStep++;
            } else if (step.type.startsWith('sent')) {
                simulateTypingInInput(step, () => {
                    const textToSend = document.getElementById('fake-input').value;
                    document.getElementById('fake-input').value = '';
                    const sendBtn = document.getElementById('send-btn');
                    sendBtn.classList.add('disabled');
                    sendBtn.disabled = true;
                    showInChat(textToSend, 'sent', () => { isTyping = false; });
                    currentStep++;
                });
            }
        }

        function simulateTypingInInput(step, onComplete) {
            const fakeInput = document.getElementById('fake-input');
            const sendBtn = document.getElementById('send-btn');
            sendBtn.classList.add('disabled'); sendBtn.disabled = true;

            const inputTypeit = new TypeIt(fakeInput, {
                speed: 100, lifeLike: true,
                afterComplete: () => {
                    sendBtn.classList.remove('disabled'); sendBtn.disabled = false;
                    setTimeout(onComplete, 300);
                }
            }).go();

            // 直接将值设置到输入框，避免TypeIt的value属性问题
            inputTypeit.reset();
            if (step.type === 'sent-ime') {
                inputTypeit.type(step.pinyin).pause(500).delete().type(step.text);
            } else {
                inputTypeit.type(step.text);
            }
        }

        function showInChat(text, type, onComplete) {
            const messageContainer = document.getElementById('message-container');
            const bubble = document.createElement('div');
            bubble.className = `message-bubble msg-${type}`;
            bubble.innerHTML = text; // 直接插入文本，不再需要TypeIt
            messageContainer.appendChild(bubble);
            messageContainer.scrollTop = messageContainer.scrollHeight;
            if(onComplete) onComplete();
        }
    </script>
</body>
</html>
