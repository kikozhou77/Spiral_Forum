<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>我的信息 - 螺旋论坛</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .chat-divider {
      border: none;
      border-top: 1px solid var(--border-color);
      margin: 16px 0;
      opacity: 0.4;
    }
    .delete-button {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.1em;
      cursor: pointer;
      margin-left: 8px;
      padding: 4px;
      transition: color 0.2s ease;
    }
    .delete-button:hover {
      color: #dc3545;
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo">螺旋论坛</div>
    <div>用户小A | <a href="messages.html">私信<span id="msg-badge" class="notification-badge">99+</span></a></div>
  </header>

  <nav>
    <a href="index.html">首页</a>
    <a href="my_follows.html">我的关注</a>
    <a href="my_profile.html">我的主页</a>
    <a href="messages.html" class="active">我的信息</a>
    <a href="post_detail.html" class="post-button">我要发帖！</a>
  </nav>

  <main>
    <div class="chat-layout">
      <div class="contact-list" id="contact-list-container">
        <h2>私信列表 <button onclick="alert('已全部设为已读！')">一键已读</button></h2>
        <div class="contact-item" data-contact-id="troll" onclick="loadChat('troll')">
          <img src="https://via.placeholder.com/48/000/FFF?text=剑" class="contact-avatar">
          <div class="contact-info">
            <div class="name">sohnwhnalqq9912_xlk</div>
            <div class="preview">...</div>
          </div>
        </div>
        <div class="contact-item" data-contact-id="user21" onclick="loadChat('user21')">
          <img src="https://via.placeholder.com/48/ccc/000?text=?" class="contact-avatar">
          <div class="contact-info">
            <div class="name">用户21</div>
            <div class="preview">...</div>
          </div>
        </div>
      </div>

      <div id="chat-content-area" class="chat-window" style="align-items: center; justify-content: center;">
        <h2 style="color: #999;">点击左侧联系人开始对话</h2>
      </div>
    </div>
  </main>
</div>

<script>
const chatData = {
  troll: {
    name: 'sohnwhnalqq9912_xlk',
    profileLink: '#',
    replies: [
      '像你这种阴暗老鼠就只敢躲在电脑后面，一定丑得惊人，在现实里活得很可怜吧。',
      '刚注册的新号，你开。',
      '我会让你后悔的。',
      '不信你可以试试。'
    ]
  },
  user21: {
    name: '用户21',
    profileLink: 'user21_profile.html',
    replies: [
      '很抱歉，冒昧打扰……我失忆了，目前只有一台电脑，我想从电脑里找到一些线索。',
      '我无法去医院。',
      '抱歉，毕竟这是一台被格式化的电脑，我想这个请求确实太强人所难了。',
      '谢谢……那就拜托您了！',
      '我可以把我的电脑权限完全对您敞开。'
    ]
  }
};

const chatHistory = {};
const chatState = {};
let activeContactId = null;

function loadChat(contactId) {
  activeContactId = contactId;
  const data = chatData[contactId];
  if (!data) return;

  const contentArea = document.getElementById('chat-content-area');
  contentArea.innerHTML = '';

  const header = document.createElement('div');
  header.classList.add('chat-header');
  header.innerHTML = `<a href="${data.profileLink}">${data.name}</a>
    <button class="delete-button" onclick="clearChat('${contactId}')" title="清空聊天">🗑</button>`;

  const messageBox = document.createElement('div');
  messageBox.classList.add('chat-messages');
  messageBox.id = 'message-container';

  contentArea.appendChild(header);
  contentArea.appendChild(messageBox);

  (chatHistory[contactId] || []).forEach(msg => {
    const bubble = document.createElement('div');
    bubble.className = `message-bubble msg-${msg.type}`;
    bubble.textContent = msg.text;
    messageBox.appendChild(bubble);
  });

  messageBox.scrollTop = messageBox.scrollHeight;

  const inputArea = document.createElement('div');
  inputArea.className = 'chat-input-area';
  inputArea.innerHTML = `
    <input type="text" id="real-input" class="chat-input" placeholder="输入消息后按 Enter...">
    <button id="send-btn" class="send-button">↑</button>
  `;
  contentArea.appendChild(inputArea);

  document.getElementById('send-btn').addEventListener('click', handleUserMessage);
  document.getElementById('real-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') handleUserMessage();
  });

  if (!chatHistory[contactId]) chatHistory[contactId] = [];
  chatState[contactId] = { shouldInsertDivider: true };

  if (chatHistory[contactId].length === 0) {
    simulateBotReply(contactId);
  }
}

function insertDividerIfNeeded() {
  const state = chatState[activeContactId];
  if (state && state.shouldInsertDivider) {
    const divider = document.createElement('hr');
    divider.className = 'chat-divider';
    document.getElementById('message-container').appendChild(divider);
    state.shouldInsertDivider = false;
  }
}

function handleUserMessage() {
  const input = document.getElementById('real-input');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';

  insertDividerIfNeeded();

  const bubble = document.createElement('div');
  bubble.className = 'message-bubble msg-sent';
  bubble.textContent = text;
  const msgBox = document.getElementById('message-container');
  msgBox.appendChild(bubble);
  msgBox.scrollTop = msgBox.scrollHeight;

  chatHistory[activeContactId].push({ text, type: 'sent' });
  updatePreview(activeContactId, text);

  simulateBotReply(activeContactId);
}

function simulateBotReply(contactId) {
  const replies = chatData[contactId]?.replies || [];
  const history = chatHistory[contactId];
  const replyIndex = history.filter(m => m.type === 'received').length;
  if (replyIndex >= replies.length) return;

  setTimeout(() => {
    if (activeContactId !== contactId) return;
    insertDividerIfNeeded();

    const text = replies[replyIndex];
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble msg-received';
    bubble.textContent = text;
    const msgBox = document.getElementById('message-container');
    msgBox.appendChild(bubble);
    msgBox.scrollTop = msgBox.scrollHeight;

    chatHistory[contactId].push({ text, type: 'received' });
    updatePreview(contactId, text);
  }, 1000);
}

function updatePreview(contactId, text) {
  const contactItem = document.querySelector(`.contact-item[data-contact-id="${contactId}"]`);
  if (contactItem) {
    const previewEl = contactItem.querySelector('.preview');
    previewEl.textContent = text.substring(0, 20) + '...';
  }
}

function clearChat(contactId) {
  if (confirm('确定要清空当前聊天记录吗？')) {
    chatHistory[contactId] = [];
    loadChat(contactId);
  }
}

document.querySelectorAll('.contact-item').forEach(item => {
  const cid = item.dataset.contactId;
  const data = chatData[cid];
  if (data && data.replies.length) {
    const previewEl = item.querySelector('.preview');
    previewEl.textContent = data.replies[0].substring(0, 20) + '...';
  }
});
</script>
</body>
</html>
