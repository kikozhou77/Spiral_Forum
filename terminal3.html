<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Terminal_a_private</title>
  <link rel="stylesheet" href="terminal_logic.css" />
  <script src="typeit.min.js"></script>
  <style>
    .avatar-preview {
      margin-top: 20px;
      border: 2px solid white;
      display: inline-block;
    }
    .avatar-preview img {
      height: 160px;
      border: 2px solid white;
    }
  </style>
</head>
<body>
  <div id="terminal"></div>

  <script>
    const terminal = document.getElementById("terminal");

    const commands = [
      ">>> [G^1@#] 初始化终端链接...",
      ">>> sudo avatar-change user21 ./avatar_new.jpg",
      "~$@#&!Q*! 验证权限中...",
      "✔ 用户身份认证成功",
      ">>> 系统校验中... 3x!V#12@%",
      "@#klsD*(#@! 上传文件中",
      "✔ 正在上传新头像...",
      "Zx*21!@&>>✔ 用户21头像修改成功 √",
      ">>> 显示新头像预览："
    ];

    function generateNoise(length = 60) {
      const density = Math.random() * 0.3 + 0.7; // 70%-100% 是乱码
      return Array.from({ length }, () =>
        Math.random() < density
          ? String.fromCharCode(33 + Math.floor(Math.random() * 94))
          : " "
      ).join("");
    }

    function insertNoiseLines(count = 3) {
      for (let j = 0; j < count; j++) {
        const div = document.createElement("div");
        div.className = "chat-line";
        div.textContent = generateNoise(50 + Math.floor(Math.random() * 30));
        terminal.appendChild(div);
      }
      terminal.scrollTop = terminal.scrollHeight;
    }

    function typeNext(instance, i = 0) {
      if (i >= commands.length) {
        instance.exec(() => {
          insertNoiseLines(5); // ✅ 显示头像前再刷一波乱码
          const div = document.createElement("div");
          div.className = "avatar-preview";
          div.innerHTML = `<img src="terminal_image/user21_new.jpg" alt="新头像">`;
          terminal.appendChild(div);
          terminal.scrollTop = terminal.scrollHeight;
          return instance;
        });
        return;
      }

      // 每条命令前插入 2~4 行乱码
      instance.exec(() => {
        insertNoiseLines(Math.floor(Math.random() * 3) + 2);
        return instance;
      });

      const line = commands[i];
      const noiseBefore = generateNoise(Math.floor(Math.random() * 20));
      const noiseAfter = generateNoise(Math.floor(Math.random() * 25));

      instance
        .type(noiseBefore + " " + line + " " + noiseAfter)
        .break()
        .pause(400)
        .exec(() => {
          terminal.scrollTop = terminal.scrollHeight;
          typeNext(instance, i + 1);
          return instance;
        });
    }

    new TypeIt("#terminal", {
      speed: 20,
      cursorChar: "_",
      lifeLike: false,
      startDelay: 300
    })
      .exec((instance) => {
        typeNext(instance);
        return instance;
      })
      .go();
  </script>
</body>
</html>
